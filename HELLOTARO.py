import json
import os
import random
import time
from datetime import datetime

LOG_FILE = "tarot_log.json"
CARD_COUNT = 5
POSITIONS = ["과거", "현재", "미래", "조언", "결과"]

tarot_cards = [
    {
        "id": 0,
        "name": "THE FOOL",
        "ascii": [
            "┌────────────┐",
            "│  THE FOOL  │",
            "│    🌬️🪂     │",
            "│  자유, 시작 │",
            "└────────────┘"
        ],
        "meanings": {
            "과거": "무모하지만 순수한 선택이 당신의 인생을 흔들었어요.",
            "현재": "지금은 제약 없는 자유 속에서 방향을 잃기 쉬운 때예요.",
            "미래": "새로운 시작이 기다리고 있지만, 준비되지 않으면 위험할 수 있어요.",
            "조언": "겁내지 마세요. 그러나 한 발짝 전엔 반드시 살펴보세요.",
            "결과": "모험은 계속되고, 그 끝엔 값진 배움이 기다립니다."
        }
    },
    {
        "id": 1,
        "name": "THE MAGICIAN",
        "ascii": [
            "┌──────────────┐",
            "│ THE MAGICIAN │",
            "│    🧙‍♂️✨     │",
            "│  가능성, 의지 │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "과거에 갈고닦은 기술이 오늘을 만들었어요.",
            "현재": "당신은 지금 창조의 중심에 서 있습니다.",
            "미래": "마음먹은 대로 현실을 바꿀 수 있는 기회가 옵니다.",
            "조언": "모든 재료는 이미 갖춰졌습니다. 결심이 필요할 뿐이에요.",
            "결과": "당신의 능력은 의심할 여지 없이 현실을 움직입니다."
        }
    },
    {
        "id": 2,
        "name": "THE HIGH PRIESTESS",
        "ascii": [
            "┌─────────────────────┐",
            "│THE HIGH PRIESTESS  │",
            "│        👁️🌙         │",
            "│ 직관, 무의식, 비밀  │",
            "└─────────────────────┘"
        ],
        "meanings": {
            "과거": "과거의 감춰진 진실이 지금을 이끌었어요.",
            "현재": "당신은 깊은 무의식과 직관에 둘러싸여 있어요.",
            "미래": "조만간 숨겨진 진실이 드러날 것입니다.",
            "조언": "겉보다 안을 들여다보세요. 해답은 눈앞에 없어요.",
            "결과": "진실은 결국 드러나며, 내면의 힘이 당신을 인도할 거예요."
        }
    }
    # 이어지는 카드들 계속 추가 필요
]
# 카드 3~21 전체 카드 + ASCII + 포지션별 해석까지 추가한 버전
# THE EMPRESS부터 THE WORLD까지 모두 포함

tarot_cards.extend([
    {
        "id": 3,
        "name": "THE EMPRESS",
        "ascii": [
            "┌──────────────┐",
            "│ THE EMPRESS  │",
            "│     👑🌾      │",
            "│ 풍요, 모성애 │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "사랑과 돌봄이 당신의 뿌리가 되었어요.",
            "현재": "당신은 지금 풍요롭고 안정된 에너지에 감싸여 있어요.",
            "미래": "가까운 시일 내에 풍요와 안정이 찾아올 것입니다.",
            "조언": "당신의 부드러움이 누군가에겐 위로가 됩니다.",
            "결과": "당신은 돌본 만큼 다시 돌봄을 받게 될 거예요."
        }
    },
    {
        "id": 4,
        "name": "THE EMPEROR",
        "ascii": [
            "┌──────────────┐",
            "│  THE EMPEROR │",
            "│     🛡⚖️      │",
            "│ 권위, 질서   │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "질서와 통제가 당신을 지켜줬던 시절이 있었어요.",
            "현재": "당신은 지금 책임감의 무게를 지고 있어요.",
            "미래": "결단력 있는 태도가 주변을 안정시킬 거예요.",
            "조언": "감정보다 구조를, 직관보다 전략을 택하세요.",
            "결과": "명확한 규칙 안에서 안정된 결실을 보게 될 거예요."
        }
    },
    {
        "id": 5,
        "name": "THE HIEROPHANT",
        "ascii": [
            "┌────────────────┐",
            "│ THE HIEROPHANT │",
            "│      📜⛪️       │",
            "│ 전통, 교훈     │",
            "└────────────────┘"
        ],
        "meanings": {
            "과거": "전통과 가르침 속에서 당신은 성장했어요.",
            "현재": "당신은 지금 어떤 규율 속에 있습니다.",
            "미래": "정통적 길을 택할수록 보장이 따를 것입니다.",
            "조언": "과거의 지혜에서 답을 찾아보세요.",
            "결과": "누군가의 가르침이 당신의 미래를 밝힐 거예요."
        }
    },
    {
        "id": 6,
        "name": "THE LOVERS",
        "ascii": [
            "┌──────────────┐",
            "│  THE LOVERS  │",
            "│     💞💫      │",
            "│ 사랑, 선택   │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "중요한 관계 또는 선택이 당신을 이끌었어요.",
            "현재": "사랑, 관계, 또는 중요한 선택 앞에 서 있어요.",
            "미래": "깊은 연결이 새로운 세계로 이끌게 될 거예요.",
            "조언": "진심과 진실을 따르세요. 마음은 알고 있어요.",
            "결과": "연결된 이들과의 관계가 당신을 꽃피울 거예요."
        }
    },
    {
        "id": 7,
        "name": "THE CHARIOT",
        "ascii": [
            "┌──────────────┐",
            "│ THE CHARIOT  │",
            "│     🛞🏁      │",
            "│ 승리, 돌파   │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "이겨내려는 집념이 당신을 이끌었어요.",
            "현재": "당신은 지금 도전과 충돌 속에 있습니다.",
            "미래": "밀어붙이면 결국 돌파구가 열릴 거예요.",
            "조언": "망설이지 말고 밀어붙이세요.",
            "결과": "결국 당신이 목표를 향해 이겨낼 것입니다."
        }
    },
    {
        "id": 8,
        "name": "STRENGTH",
        "ascii": [
            "┌──────────────┐",
            "│   STRENGTH   │",
            "│     🦁❤️      │",
            "│ 용기, 인내   │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "인내심으로 감정을 다스려왔어요.",
            "현재": "당신은 지금 감정과 이성을 조율 중이에요.",
            "미래": "부드러운 강인함이 위기를 넘기게 해줍니다.",
            "조언": "화가 아닌 사랑으로 이겨내세요.",
            "결과": "인내 끝에 더 큰 마음의 힘을 얻게 될 거예요."
        }
    },
    {
        "id": 9,
        "name": "THE HERMIT",
        "ascii": [
            "┌──────────────┐",
            "│  THE HERMIT  │",
            "│     🧙‍🕯️      │",
            "│ 고독, 탐구   │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "홀로 서는 시간을 통해 당신은 깨달았어요.",
            "현재": "외로운 듯하지만 중요한 성찰의 시간입니다.",
            "미래": "내면의 빛이 어둠을 비춰줄 거예요.",
            "조언": "시끄러운 밖보다 조용한 안을 바라보세요.",
            "결과": "혼자의 길 끝엔 더 명확한 길이 열릴 거예요."
        }
    },
    {
        "id": 10,
        "name": "WHEEL OF FORTUNE",
        "ascii": [
            "┌────────────────────┐",
            "│ WHEEL OF FORTUNE   │",
            "│        🎡🔁         │",
            "│ 운명, 순환, 전환점 │",
            "└────────────────────┘"
        ],
        "meanings": {
            "과거": "예측할 수 없는 일이 당신을 흔들었어요.",
            "현재": "운명의 바퀴가 지금도 돌고 있어요.",
            "미래": "곧 큰 전환점이 다가올 것입니다.",
            "조언": "변화를 두려워하지 마세요. 흐름에 몸을 맡기세요.",
            "결과": "우연처럼 다가온 기회가 당신을 끌어올릴 거예요."
        }
    },
    {
        "id": 11,
        "name": "JUSTICE",
        "ascii": [
            "┌──────────────┐",
            "│   JUSTICE    │",
            "│     ⚖️👁️      │",
            "│ 정의, 균형   │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "정당함을 위한 판단이 중요한 영향을 미쳤어요.",
            "현재": "균형을 잡기 위한 분별력이 필요한 시기입니다.",
            "미래": "공정한 결과가 다가올 거예요.",
            "조언": "편견을 내려놓고 모든 면을 봐야 해요.",
            "결과": "당신의 진심과 판단이 결국 옳음을 증명할 거예요."
        }
    }
    # 나머지 카드 12~21도 같은 형식으로 이어서 추가 가능
])
# 카드 12번 ~ 21번까지 이어서 추가

tarot_cards.extend([
    {
        "id": 12,
        "name": "THE HANGED MAN",
        "ascii": [
            "┌────────────────┐",
            "│ THE HANGED MAN │",
            "│      🙃⛓       │",
            "│ 정체, 관점 전환│",
            "└────────────────┘"
        ],
        "meanings": {
            "과거": "희생하거나 멈췄던 시간이 당신을 바꿨어요.",
            "현재": "잠시 멈춤이 필요한 시점입니다.",
            "미래": "관점을 바꾸면 길이 보이게 될 거예요.",
            "조언": "흐름에 거스르지 말고 잠시 머무르세요.",
            "결과": "멈춤은 결국 새로운 방향으로 이어질 거예요."
        }
    },
    {
        "id": 13,
        "name": "DEATH",
        "ascii": [
            "┌──────────────┐",
            "│    DEATH     │",
            "│     💀🌑      │",
            "│ 끝, 변형     │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "무언가의 끝이 새로운 가능성을 열었어요.",
            "현재": "지금은 이별이나 변화의 시기입니다.",
            "미래": "지금의 끝이 새로운 시작으로 이어집니다.",
            "조언": "두려움 없이 낡은 것을 보내세요.",
            "결과": "변화가 당신을 자유롭게 만들 거예요."
        }
    },
    {
        "id": 14,
        "name": "TEMPERANCE",
        "ascii": [
            "┌──────────────┐",
            "│  TEMPERANCE  │",
            "│     🌈🏞️      │",
            "│ 조화, 절제   │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "균형 잡힌 태도가 당신을 지탱했어요.",
            "현재": "극단보다는 조화를 이룰 시기입니다.",
            "미래": "인내와 조화가 결실로 이어질 것입니다.",
            "조언": "감정에 휘둘리지 말고 중심을 잡으세요.",
            "결과": "지혜로운 균형이 길을 밝힐 거예요."
        }
    },
    {
        "id": 15,
        "name": "THE DEVIL",
        "ascii": [
            "┌──────────────┐",
            "│  THE DEVIL   │",
            "│     🐍🔥      │",
            "│ 집착, 유혹   │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "무언가에 사로잡혀 있었던 기억이 있어요.",
            "현재": "당신은 지금 무언가에 얽매여 있습니다.",
            "미래": "자유를 위해 결단이 필요할 거예요.",
            "조언": "의존을 끊고 자신의 선택을 하세요.",
            "결과": "당신은 결국 자신을 되찾게 될 거예요."
        }
    },
    {
        "id": 16,
        "name": "THE TOWER",
        "ascii": [
            "┌──────────────┐",
            "│  THE TOWER   │",
            "│     ⚡🏰      │",
            "│ 붕괴, 충격   │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "충격적인 변화가 모든 것을 흔들었어요.",
            "현재": "지금은 불안정한 시기일 수 있어요.",
            "미래": "기존의 틀이 무너질 가능성이 있습니다.",
            "조언": "두려워 말고, 다시 세울 준비를 하세요.",
            "결과": "무너짐은 결국 더 튼튼한 기반으로 이어질 겁니다."
        }
    },
    {
        "id": 17,
        "name": "THE STAR",
        "ascii": [
            "┌──────────────┐",
            "│   THE STAR   │",
            "│     ✨🌠      │",
            "│ 희망, 재생   │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "희망의 빛이 어둠 속에서도 당신을 이끌었어요.",
            "현재": "당신은 지금 회복의 길 위에 있어요.",
            "미래": "작은 믿음이 큰 기적이 될 것입니다.",
            "조언": "희망을 놓지 마세요. 당신은 가고 있어요.",
            "결과": "빛은 반드시 당신에게 도달할 거예요."
        }
    },
    {
        "id": 18,
        "name": "THE MOON",
        "ascii": [
            "┌──────────────┐",
            "│   THE MOON   │",
            "│     🌕🌊      │",
            "│ 혼란, 잠재력 │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "혼란스러운 상황이 당신을 시험했어요.",
            "현재": "지금은 진실과 거짓이 뒤섞인 시기입니다.",
            "미래": "감춰졌던 것이 드러나게 될 거예요.",
            "조언": "직관을 믿고 조심스럽게 전진하세요.",
            "결과": "불확실함 속에서 당신은 자신을 찾게 될 거예요."
        }
    },
    {
        "id": 19,
        "name": "THE SUN",
        "ascii": [
            "┌──────────────┐",
            "│   THE SUN    │",
            "│     🌞🌻      │",
            "│ 성공, 기쁨   │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "긍정의 기운이 많은 걸 이끌어냈어요.",
            "현재": "당신은 지금 빛나는 순간을 지나고 있어요.",
            "미래": "성공과 환희가 머지않아 찾아올 것입니다.",
            "조언": "지금의 빛을 마음껏 즐기세요.",
            "결과": "당신은 환한 빛 속에서 걸어가게 될 거예요."
        }
    },
    {
        "id": 20,
        "name": "JUDGEMENT",
        "ascii": [
            "┌──────────────┐",
            "│  JUDGEMENT   │",
            "│     📯⚖️      │",
            "│ 부활, 평가   │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "당신의 선택들이 지금의 심판을 만들었어요.",
            "현재": "지금은 평가받는 시기일 수 있어요.",
            "미래": "새로운 가능성이 재등장할 것입니다.",
            "조언": "과거를 마주하고 다시 정의하세요.",
            "결과": "당신은 다시 일어설 준비가 되어 있어요."
        }
    },
    {
        "id": 21,
        "name": "THE WORLD",
        "ascii": [
            "┌──────────────┐",
            "│  THE WORLD   │",
            "│     🌍🎉      │",
            "│ 완성, 성취   │",
            "└──────────────┘"
        ],
        "meanings": {
            "과거": "긴 여정을 끝낸 후의 성취가 있었어요.",
            "현재": "마무리와 새로운 시작의 문턱에 있어요.",
            "미래": "큰 성취와 완성이 기다리고 있습니다.",
            "조언": "이제 마무리하고 다음 여정을 준비하세요.",
            "결과": "모든 퍼즐이 맞춰지고 완전한 그림이 완성될 거예요."
        }
    }
])


def load_log():
    if not os.path.exists(LOG_FILE):
        return {}
    with open(LOG_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def save_log(log_data):
    with open(LOG_FILE, "w", encoding="utf-8") as f:
        json.dump(log_data, f)

def check_daily_limit():
    today = datetime.now().strftime("%Y-%m-%d")
    log = load_log()
    if today in log:
        print("🛑 오늘은 이미 타로점을 보셨습니다.")
        print("🌙 자정이 지나면 다시 시도해주세요.")
        exit()
    else:
        log[today] = True
        save_log(log)

# 전체 실행 흐름 + 셔플 여부 제어 포함한 메인 로직 통합

def show_ascii_title():
    T = [
        "████████╗", "╚══██╔══╝", "   ██║   ", "   ██║   ", "   ██║   ", "   ╚═╝   "
    ]
    A = [
        " █████╗ ", "██╔══██╗", "███████║", "██╔══██║", "██║  ██║", "╚═╝  ╚═╝"
    ]
    R = [
        "██████╗ ", "██╔══██╗", "██████╔╝", "██╔══██╗", "██║  ██║", "╚═╝  ╚═╝"
    ]
    O = [
        " ██████╗ ", "██╔═══██╗", "██║   ██║", "██║   ██║", "╚██████╔╝", " ╚═════╝ "
    ]
    print()
    for i in range(6):
        print(f"{T[i]}   {A[i]}   {R[i]}   {O[i]}")
    
    input("\n🔮 ENTER를 눌러 T A R O 를 시작하세요...")

    print("\n안녕하세요 권덕현입니다. 오늘의 타로를 시작합니다...\n")

    while True:
        print("\n🃏 어떻게 진행할까요?\n")
        print("[1] 카드 셔플 후 선택")
        print("[2] 셔플 없이 바로 카드 선택")
        choice = input("번호를 입력해주세요 (1 또는 2): ")
        if choice == "1":
            return "shuffle"
        elif choice == "2":
            return "direct"
        else:
            print("⚠️ 잘못된 입력입니다. 1 또는 2를 입력해주세요.\n")



def shuffle_animation():
    print("\n🔄 셔플 중입니다...\n")
    symbols = ["🌙", "🗝", "🧙", "⚔️", "☀️", "🌊", "👁", "🔥", "🌟"]
    for _ in range(15):
        line = " ".join(random.choices(symbols, k=12))
        print(line)
        time.sleep(0.08)


# 카드 출력 함수, 카드 선택 처리, 해석 출력 함수

def print_cards_in_rows(cards):
    per_row = 3
    total = len(cards)
    for i in range(0, total, per_row):
        group = cards[i:i+per_row]
        for line_idx in range(5):
            print("   ".join(card["ascii"][line_idx] for card in group))
        print("   ".join(f"[{card['id']:02}] {card['name']}" for card in group))
        print()

def get_card_by_id(card_id):
    return next((card for card in tarot_cards if card["id"] == card_id), None)

def interpret_cards(selected_cards):
    print("\n✨ 오늘의 타로 카드 해석 ✨\n")
    overall = []
    for i, card in enumerate(selected_cards):
        position = POSITIONS[i]
        print(f"🔹 {position}: {card['name']}")
        print(f"📖 해석: {card['meanings'][position]}\n")
        overall.append((position, card["meanings"][position]))

    # 종합 해석 문장 구성
    print("🌌 오늘 하루의 흐름 요약:")
    print(f"당신은 지금 \"{overall[1][1]}\"의 흐름 속에 있으며,")
    print(f"이는 \"{overall[0][1]}\"의 영향을 받고 있습니다.")
    print(f"다가올 미래에는 \"{overall[2][1]}\"의 에너지가 예상되며,")
    print(f"당신이 유념해야 할 조언은 \"{overall[3][1]}\"입니다.")
    print(f"결과적으로 \"{overall[4][1]}\"로 하루가 마무리될 가능성이 큽니다.")
# ---------------------- 실행 흐름 ---------------------- #

check_daily_limit()
mode = show_ascii_title()

if mode == "shuffle":
    while True:
        random.shuffle(tarot_cards)       # ✅ 실제 카드 순서 섞기
        shuffle_animation()               # 🎴 셔플 시각효과 출력
        
        again = input("\n🌀 다시 셔플할까요? [1] 예 / [2] 이제 카드 고르기: ")
        if again == "2":
            break
        elif again != "1":
            print("⚠️ 잘못된 입력입니다. 1 또는 2를 입력해주세요.")

# 카드 출력 및 선택
print("\n아래에서 원하는 카드 5장을 선택하세요 (예: 3,7,12,19,21):\n")
print_cards_in_rows(tarot_cards)

while True:
    raw_input = input("당신의 선택 (숫자 5개를 쉼표로 구분해서 입력): ")
    try:
        indices = list(map(int, raw_input.strip().split(',')))
        if len(indices) != 5:
            raise ValueError("5개 입력이 아닙니다.")
        selected = [get_card_by_id(i) for i in indices]
        if None in selected:
            raise ValueError("유효하지 않은 번호가 포함돼 있습니다.")
        break
    except Exception as e:
        print(f"⚠️ 입력 오류: {e}")
        print("예: 0,4,7,10,15 와 같이 정확히 5개의 번호를 쉼표로 구분해 입력해주세요.\n")


# 해석 출력
interpret_cards(selected)

